{% extends "base.html" %}

{% block title %}Terrain Sense Lab{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero hero-alt text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-7 animate-in" style="animation-delay: 0.2s;">
                <p class="eyebrow text-uppercase mb-3">experimental housing lab</p>
                <h1 class="display-4 fw-semibold mb-4 lh-base">
                    Fresh intel for pricing the places people actually want to live.
                </h1>
                <p class="lead mb-4 text-hero-muted">Terrain Sense blends California census signals, handcrafted feature art, and a calmer UI story so you can quote with confidence.</p>
                <div class="badge-stack mb-4">
                    <span class="badge rounded-pill bg-basil">live inference</span>
                    <span class="badge rounded-pill bg-peach">contextual sliders</span>
                    <span class="badge rounded-pill bg-lilac">bilingual helper</span>
                </div>
                <div class="mt-4 d-flex gap-3 flex-wrap">
                    <a href="#predictor" class="btn btn-contrast btn-lg">
                        <i class="fas fa-wand-magic-sparkles me-2"></i>Launch Studio
                    </a>
                    <a href="#visualizations" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-layer-group me-2"></i>See Evidence
                    </a>
                </div>
            </div>
            <div class="col-lg-5 text-center animate-in" style="animation-delay: 0.4s;">
                <div class="hero-card glass-stack">
                    <div class="hero-card__orb"></div>
                    <div class="hero-card__content">
                        <p class="text-uppercase small text-muted mb-1">instant moodboard</p>
                        <h3 class="fw-bold mb-3">Terrain Sense Lab</h3>
                        <ul class="list-unstyled text-start small mb-0">
                            <li><i class="fas fa-check text-accent me-2"></i>California-only training</li>
                            <li><i class="fas fa-check text-accent me-2"></i>Fresh palette & typography</li>
                            <li><i class="fas fa-check text-accent me-2"></i>Zero canned copy reuse</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Story Section -->
<section class="py-5" id="about">
    <div class="container">
        <div class="section-header">
            <p class="eyebrow">Story</p>
            <h2 class="animate-in">Why this lab feels brand new</h2>
            <p class="animate-in section-desc">We stripped the typical dashboard gloss and rebuilt the interface like a boutique research zine—soft gradients, breathable spacing, and deliberately rewritten microcopy.</p>
            <hr class="mx-auto animate-in" style="animation-delay: 0.3s;">
        </div>
        <div class="row g-4">
            <div class="col-md-6 animate-in" style="animation-delay: 0.4s;">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4">
                            <i class="fas fa-feather-pointed feature-icon me-2"></i>
                            Narrative-first overview
                        </h4>
                        <p class="card-text">This refresh turns a familiar California Housing demo into a fresh brand moment. We highlight the craft—feature engineering, thoughtful defaults, and bilingual helpers—through conversational copy rather than boilerplate jargon.</p>
                        <p class="card-text">Random Forest still powers the predictions, but its story is framed like a studio release with curated badges and interactive cues.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 animate-in" style="animation-delay: 0.5s;">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4">
                            <i class="fas fa-database feature-icon me-2"></i>
                            Dataset ingredients
                        </h4>
                        <p class="card-text">The 1990 California census is still the muse. We surfaced the richest columns and paired them with reasons to care:</p>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="data-chip">
                                    <i class="fas fa-map-marker-alt me-2"></i>Latitude & longitude for vibe-aware placement
                                </div>
                                <div class="data-chip">
                                    <i class="fas fa-home me-2"></i>Median age for architectural backstory
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="data-chip">
                                    <i class="fas fa-users me-2"></i>Population + households for density clues
                                </div>
                                <div class="data-chip">
                                    <i class="fas fa-money-bill-wave me-2"></i>Income bands for spending power
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 animate-in" style="animation-delay: 0.6s;">
                <div class="metric-panel">
                    <div>
                        <p class="metric-label">RMSE</p>
                        <h3>{{ "%.2f"|format(rmse) }}</h3>
                        <p class="metric-desc">Lower is cleaner. Our Random Forest sits comfortably.</p>
                    </div>
                    <div>
                        <p class="metric-label">R²</p>
                        <h3>{{ "%.2f"|format(r2) }}</h3>
                        <p class="metric-desc">Close to 1 means the story sticks to the data.</p>
                    </div>
                    <div>
                        <p class="metric-label">Model stack</p>
                        <h3>RF + care</h3>
                        <p class="metric-desc">Random Forest beats our linear baselines in this release.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Predictor Section -->
<section class="py-5 predictor-shell" id="predictor">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center mb-4" data-aos="fade-up">
                <p class="eyebrow text-center">Studio</p>
                <h2 class="typing-animation">Design your scenario</h2>
                <p>Dial in the location, density, and lifestyle cues. The studio responds instantly with a fresh valuation.</p>
                <hr class="mx-auto" style="width: 70px;">
            </div>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-body">
                        <form id="prediction-form">
                            <div class="row">
                                <!-- Location Features -->
                                <div class="col-md-6 mb-3">
                                    <div class="feature-label">
                                        <label for="longitude" class="form-label">Longitude</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="East-West position on map / पूर्व-पश्चिम स्थिति">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="range" class="form-range" id="longitude" name="longitude" 
                                           min="{{ feature_ranges.longitude.min|round(2) }}" 
                                           max="{{ feature_ranges.longitude.max|round(2) }}" 
                                           step="0.01" 
                                           value="{{ feature_ranges.longitude.default|round(2) }}">
                                    <div class="d-flex justify-content-between">
                                        <span>{{ feature_ranges.longitude.min|round(2) }}</span>
                                        <span id="longitude-value">{{ feature_ranges.longitude.default|round(2) }}</span>
                                        <span>{{ feature_ranges.longitude.max|round(2) }}</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="feature-label">
                                        <label for="latitude" class="form-label">Latitude</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="North-South position on map / उत्तर-दक्षिण स्थिति">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="range" class="form-range" id="latitude" name="latitude" 
                                           min="{{ feature_ranges.latitude.min|round(2) }}" 
                                           max="{{ feature_ranges.latitude.max|round(2) }}" 
                                           step="0.01" 
                                           value="{{ feature_ranges.latitude.default|round(2) }}">
                                    <div class="d-flex justify-content-between">
                                        <span>{{ feature_ranges.latitude.min|round(2) }}</span>
                                        <span id="latitude-value">{{ feature_ranges.latitude.default|round(2) }}</span>
                                        <span>{{ feature_ranges.latitude.max|round(2) }}</span>
                                    </div>
                                </div>
                                
                                <!-- Housing Features -->
                                <div class="col-md-4 mb-3">
                                    <div class="feature-label">
                                        <label for="housing_median_age" class="form-label">Housing Median Age</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="Median age of houses in the area / क्षेत्र में मकानों की औसत आयु">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="number" class="form-control enhanced-input" id="housing_median_age" name="housing_median_age" 
                                           min="1" max="100" step="1" value="{{ feature_ranges.housing_median_age.default|round(0) }}">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="feature-label">
                                        <label for="total_rooms" class="form-label">Total Rooms</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="Total number of rooms in the area / क्षेत्र में कमरों की कुल संख्या">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="number" class="form-control enhanced-input" id="total_rooms" name="total_rooms" 
                                           min="1" max="50000" step="1" value="{{ feature_ranges.total_rooms.default|round(0) }}">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="feature-label">
                                        <label for="total_bedrooms" class="form-label">Total Bedrooms</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="Total number of bedrooms in the area / क्षेत्र में बेडरूम की कुल संख्या">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="number" class="form-control enhanced-input" id="total_bedrooms" name="total_bedrooms" 
                                           min="1" max="10000" step="1" value="{{ feature_ranges.total_bedrooms.default|round(0) }}">
                                </div>
                                
                                <!-- Population Features -->
                                <div class="col-md-6 mb-3">
                                    <div class="feature-label">
                                        <label for="population" class="form-label">Population</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="Number of people in the area / क्षेत्र में लोगों की संख्या">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="number" class="form-control enhanced-input" id="population" name="population" 
                                           min="1" max="20000" step="1" value="{{ feature_ranges.population.default|round(0) }}">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="feature-label">
                                        <label for="households" class="form-label">Households</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="Number of households in the area / क्षेत्र में परिवारों की संख्या">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="number" class="form-control enhanced-input" id="households" name="households" 
                                           min="1" max="10000" step="1" value="{{ feature_ranges.households.default|round(0) }}">
                                </div>
                                
                                <!-- Economic Features -->
                                <div class="col-md-6 mb-3">
                                    <div class="feature-label">
                                        <label for="median_income" class="form-label">Median Income ($10,000s)</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="Median income in blocks of $10,000 / $10,000 के ब्लॉक में औसत आय">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <input type="range" class="form-range" id="median_income" name="median_income" 
                                           min="{{ feature_ranges.median_income.min|round(2) }}" 
                                           max="{{ feature_ranges.median_income.max|round(2) }}" 
                                           step="0.1" 
                                           value="{{ feature_ranges.median_income.default|round(2) }}">
                                    <div class="d-flex justify-content-between">
                                        <span>{{ feature_ranges.median_income.min|round(2) }}</span>
                                        <span id="median_income-value">{{ feature_ranges.median_income.default|round(2) }}</span>
                                        <span>{{ feature_ranges.median_income.max|round(2) }}</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="feature-label">
                                        <label for="ocean_proximity" class="form-label">Ocean Proximity</label>
                                        <span class="feature-tooltip" data-bs-toggle="tooltip" title="Distance category to the ocean / समुद्र से दूरी की श्रेणी">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </div>
                                    <select class="form-select enhanced-input" id="ocean_proximity" name="ocean_proximity">
                                        {% for value in ocean_proximity_values %}
                                        <option value="{{ value }}">{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Submit Button -->
                                <div class="col-12 text-center mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg px-5 py-3" style="border-radius: 30px;">
                                        <i class="fas fa-sparkles me-2"></i>Predict with Flair
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Prediction Result -->
                <div id="prediction-result" class="card mt-4 shadow d-none">
                    <div class="card-body text-center py-4">
                        <div class="mb-3">
                            <span class="badge bg-success px-3 py-2 mb-3">Prediction Complete</span>
                        </div>
                        <h4 class="card-title mb-3">Fresh estimate</h4>
                        <h2 class="display-3 fw-bold" id="price-value">$0</h2>
                        <div class="mt-3 pt-2">
                            <p class="text-muted">Rooted in your sliders & categorical vibes.</p>
                            <button type="button" class="btn btn-outline-primary mt-2" onclick="window.location.href='#visualizations'">
                                <i class="fas fa-chart-line me-2"></i>Inspect the proof
                            </button>
                        </div>
                    </div>
                </div>

                {% set median_ratio = ((price_stats.median - price_stats.min) / (price_stats.max - price_stats.min) * 100) if price_stats.max != price_stats.min else 50 %}
                <div id="prediction-proof" class="card mt-4 d-none proof-card"
                     data-min="{{ price_stats.min }}"
                     data-max="{{ price_stats.max }}"
                     data-mean="{{ price_stats.mean }}"
                     data-median="{{ price_stats.median }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <p class="eyebrow mb-1">Live evidence</p>
                                <h5 class="mb-0">Where this quote sits in the dataset</h5>
                            </div>
                            <span class="badge rounded-pill bg-lilac text-dark">auto-updates</span>
                        </div>
                        <p class="text-muted small mb-3">Every time you run the Studio, we place that value across the historical price distribution for quick sanity checks.</p>
                        <div class="proof-bar">
                            <div class="proof-bar-track"></div>
                            <div class="proof-marker" id="proof-marker"></div>
                            <div class="proof-notch" style="left: {{ median_ratio|round(2) }}%;" title="Dataset median"></div>
                        </div>
                        <div class="d-flex justify-content-between text-muted small mt-2 flex-wrap gap-2">
                            <span>Min ${{ price_stats.min|round(0)|int }}</span>
                            <span>Median ${{ price_stats.median|round(0)|int }}</span>
                            <span>Max ${{ price_stats.max|round(0)|int }}</span>
                        </div>
                        <div class="mt-3">
                            <p class="text-muted small mb-1">Latest prediction</p>
                            <div class="d-flex align-items-baseline gap-3 flex-wrap">
                                <h4 class="mb-0" id="proof-current">$0</h4>
                                <span class="badge bg-peach text-dark" id="proof-position">Waiting for studio input...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sample Data -->
                <div class="card mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Sample rows straight from census</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Long.</th>
                                        <th>Lat.</th>
                                        <th>Age</th>
                                        <th>Rooms</th>
                                        <th>Bedrooms</th>
                                        <th>Pop.</th>
                                        <th>Households</th>
                                        <th>Income</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in sample_data %}
                                    <tr>
                                        <td>{{ row.longitude|round(2) }}</td>
                                        <td>{{ row.latitude|round(2) }}</td>
                                        <td>{{ row.housing_median_age }}</td>
                                        <td>{{ row.total_rooms|round(0) }}</td>
                                        <td>{{ row.total_bedrooms|round(0) }}</td>
                                        <td>{{ row.population|round(0) }}</td>
                                        <td>{{ row.households|round(0) }}</td>
                                        <td>{{ row.median_income|round(2) }}</td>
                                        <td>${{ row.median_house_value|round(0)|int }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Visualizations Section -->
<section class="py-5" id="visualizations">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center mb-4" data-aos="fade-up">
                <p class="eyebrow">Evidence</p>
                <h2>Visual proof the lab delivers</h2>
                <hr class="mx-auto" style="width: 70px;">
            </div>
        </div>
        
        <div class="row">
            <!-- Feature Importance -->
            <div class="col-md-6 mb-4" data-aos="fade-right" data-aos-delay="100">
                <div class="card h-100 shadow">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Feature Importance</h5>
                    </div>
                    <div class="card-body text-center">
                        <img src="data:image/png;base64,{{ feature_plot }}" alt="Feature Importance" class="img-fluid" data-tooltip="Click to enlarge">
                        <p class="mt-3">The more saturated the bar, the stronger the signal shaping your quote.</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="tooltip" title="Learn more about feature importance">
                            <i class="fas fa-info-circle me-1"></i>Learn More
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Prediction Accuracy -->
            <div class="col-md-6 mb-4" data-aos="fade-left" data-aos-delay="200">
                <div class="card h-100 shadow">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Prediction Accuracy</h5>
                    </div>
                    <div class="card-body text-center">
                        <img src="data:image/png;base64,{{ predictions_plot }}" alt="Prediction Accuracy" class="img-fluid" data-tooltip="Click to enlarge">
                        <p class="mt-3">Dots hugging the diagonal mean your slider art matches what happened in census reality.</p>
                        <div class="mt-3 d-flex justify-content-center">
                            <span class="badge bg-success me-2 p-2">RMSE: {{ "%.2f"|format(rmse) }}</span>
                            <span class="badge bg-primary p-2">R²: {{ "%.2f"|format(r2) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Update slider value displays
    document.querySelectorAll('input[type="range"]').forEach(function(slider) {
        slider.addEventListener('input', function() {
            document.getElementById(this.id + '-value').textContent = this.value;
        });
    });
    
    // Add pulse animation class
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(94, 114, 228, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(94, 114, 228, 0); }
                100% { box-shadow: 0 0 0 0 rgba(94, 114, 228, 0); }
            }
            .btn-pulse {
                animation: pulse 1.5s infinite;
            }
        </style>
    `);
    
    // Important: We're using simple-predict.js instead of the inline script
    // The form submission handler is now in that file
</script>
{% endblock %}